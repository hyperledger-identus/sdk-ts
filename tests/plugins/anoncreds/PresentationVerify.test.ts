import { vi, describe, expect, test, beforeEach } from 'vitest';
import { Task } from '../../../src/utils';
import * as FetchCredModule from "../../../src/plugins/internal/anoncreds/FetchCredentialDefinition";
import * as FetchSchemaModule from "../../../src/plugins/internal/anoncreds/FetchSchema";
import * as Fixtures from "../../fixtures";
import { AnoncredsLoader } from '../../../src/plugins/internal/anoncreds/module/AnoncredsLoader';
import { PresentationVerify } from '../../../src/plugins/internal/anoncreds/PresentationVerify';
import { Pluto, RequestPresentation } from '../../../src';
import { AttachmentDescriptor, Message } from '../../../src/domain';
import { createInstance } from '../../fixtures/pluto';

describe("Plugins - Anoncreds", () => {
  let ctx: Task.Context;
  let pluto: Pluto;

  beforeEach(() => {
    pluto = createInstance().pluto
    ctx = new Task.Context({
      Pluto: pluto,
      Anoncreds: new AnoncredsLoader(),
    });

    vi.spyOn(pluto, "getLinkSecret").mockResolvedValue(Fixtures.Credentials.Anoncreds.linkSecret);
    vi.spyOn(FetchCredModule, "FetchCredentialDefinition").mockReturnValue({
      run: () => Promise.resolve(Fixtures.Credentials.Anoncreds.credentialDefinition),
      log: () => ({}),
    } as any);
    vi.spyOn(FetchSchemaModule, "fetchSchema").mockReturnValue({
      run: () => Promise.resolve(Fixtures.Credentials.Anoncreds.schema),
      log: () => ({}),
    } as any);
  });

  describe("PresentationVerify", () => {
    const thid = "test-thread-id";

    const presentation = {
      proof: {
        proofs: [
          {
            primary_proof: {
              eq_proof: {
                revealed_attrs: {
                  name: "72155939486846849509759369733266486982821795810448245423168957390607644363272",
                },
                a_prime: "1685349013305675563293969035056369165934573444034332453160671145408899281009216165537722437634253394637753857306634948317455386242636115590889617431055039494551485088595590475577085694765411751666512548092003393491081915912434945779876447738408988662031447174300113745188027849538170067041054193019258645040544910619590444953761422249034443071689144397226728862057015705976417255456174121613562052157416018482755806790235833144688060315758243165119439836629307729955161538837905610068581029221118274235280878407483246680481988437404550805757981194067286652983852027538454615556646765021375785185987196510135519831734",
                e: "47936763190066143132672417795060724519732624058204598505364871455548305903706477166839143015639631335391813848000841462277270399355799539",
                v: "1210331878579263238781603670601931740256122135224384246664831571797073449842338579440966958011500931279701619283937733531450463718996773531096328363297073984244285477863122455184659236409470729866959699786081924999893417316078383729438705685198591150933650658374693920950223397585890108110830964954566636206426613324574750189015603440599153225038674560249773715912624059210022344772016192756086093722907538768663474064797406191577579349993257395479084291509687759233899726925717885001217975078277194984491875977164216528443273771927861868618909655802633051431043158117714580447936185831374710262590158065125037833516961883725238036967870098944835893835175068566022838107296083994719864494999825676564803334888697298611122017884404866567828887201799137859162263994715052543730469250867288034579195442333826566196857798937570222864552780746824370690041363144809181132552393140687951526977546248489464941071226320174677861667",
                m: {
                  age: "8131649707814904014141426751861254140244857332050317458841503042110216419093481757473733625323123641731496276277960922466302979265578851464885510284825995299446748135937916977603",
                  master_secret: "101502322943819056401353735706848541162970318151419480721949976358635148466757218851908575316895697424826242166317182465795714520313112493273806927395865125178456292605183853922",
                },
                m2: "12630926983132400131885933325054142770527086008376407819050806926263954723281544242594503900294395544344500466277691681578863849463290641904946460124408923543881299225884172861033",
              },
              ge_proofs: [
                {
                  u: {
                    "0": "13594602047226180020340346476947011934246835926341409247156083474792158148796695091257848908217577901075797010053065258260358842090757670397444822777604794650499355867490169424359",
                    "1": "1406580258597117032889664532933358979812139796722692586814415358892098162764552852713043987579442896818681451525105048721570263391940963183111591357037843609111763303521861856746",
                    "2": "8226691798283916826949050243747165125347294938188267913266542214064983780068693355176098085169894957461451316258618251282503909044606900468377809276758595861570736740946679480676",
                    "3": "10417526267619447870288116926174026717775573820484630765766424960345632089621094003955538793521774012540070764932235964287060197356269157675198386291765352613560121799625777040665",
                  },
                  r: {
                    "0": "141114963053587434972182077670397417123797904028000972425879716858953158145961174258743833162544169291275992633915865319312882903279303850311924347853366683751060891300817001897085460055090354761671872800350130546892759320160759972227392448706892214359221145007695427858048535701411964698342178423235618292348262920389517726092934012071061406112747982351226309498144575641147308658800458793389979976931041371788280231819300088641680895436736783007939869689663309188185716841428822808458467333512096940554363268962551749961431781951874502663349694330398950427294330003838430756813298233140375437030815130822858642018020597441680555378752973023021638086941824186677307627233524453472499529379919873626901072811224886885",
                    "1": "751511177739827888189938952738707647137716958837482416221357690372194162085735786018606817168101269637870682260744453949913244757740914215325768641018320437691088286586337984645473333458900470254020920732463045398879036422195800073514581064869739758408175797039408396823166865075369945769732733117604177322539702101498487569083674778997407335405301917418854173411444171460713208342766251008947214001524824865786116567453463439763485418507284495006292443953426505920044409069622998849534386813034591854364776938228609923045236252210645901159770340783422679704783125300916468150041737492882813020796666361366066418235105952780059379425849298379843547058641263529855994385772159362552860742874516225098475275959568478119",
                    "2": "798330409215287603425819040593061210710330835689551457127502880575154801140058475440659833469423597825712612478022947896014737139316922024834566217473462004426919123063134593189073289303593113877230152732750593541745230246810513248540730569728549621125340480658186189128351600441684854773196597526635495133319107323259732262020186451319113942531023746525126908666137147173407271841745460647166751359677571720678731118874500549532383284050640570412960217494787025384580459615268894510611681702795470031707017924601414093153368802159108726339960414601335966554436109996891019049646611591224990960048249456858604160139084490639199506963625852569013429617066062982394458606533888339867212607971557936924687675434970940662",
                    "3": "803931157897200494100151378004910930956098564145028607031188362764108813700886796688779132509609326081465307081977209647793879200711522172139521127668522878944512141316796911309949246894891971971756997547111037640491533568227666386685950885245967483678063361208189685772389137636575825648732597792646299286667904103440651886711611365835678296725966514870619331605230180321784893373570900245083240364635806899488188471893252956526415324717697453439515907349469353899061310746389895096544448092212092478017069187088600896184456162619526005197847774590733725715605941653684129475475845830876475397303848386534949862897792923375246456380030060060753303585915673949779079247503954902534508035381816395473295421601031789206",
                    DELTA: "1123148876955038782714022883271013042006113912069055423858679191436578762130140592716290652472512266934985923491508239130763693883750836481136954714918663020335261724913808972322623748341483787550202784005511466636595969371357376147537695976872491050438116030639504789506850366983536806218394322683245905916295382289607273248716053348978978264696838670533398699184845231818559510187463958552571214037445657397353512287245163954864510146287456355922032070408671437058866583623110436469362329656644144030991912800446597506625175971603756595583738306449967966080072585596320341317102982125301909952434871907849938050447728834091770189045075147444492347485407391939797245185433711983774538457275974222617445852993764495902",
                  },
                  mj: "8131649707814904014141426751861254140244857332050317458841503042110216419093481757473733625323123641731496276277960922466302979265578851464885510284825995299446748135937916977603",
                  alpha: "17414834205223304631453928397919867035937960776240824815923661891009625308073198801001756246368167251257244519091657089728510935440907012510605854539948005985438733175243232389873631452022653485420410482696228833160254551469800859029565236385182440844555211274838812856913963865561743794595560084133428492591648474745758594730227151233196021915718994327815831754767073914401251264959967388021520362044130202396040104323744917899345392761829515103849460294150211244999128562418443555840215213846093144110854222193585981495531733734846508962463569386202763518400520203110200425750446361424763050082763231777264368722083956967064739851358410681848981603296317072316332634969025135068640916975948448231086734928658365718057047303118075893003620303759231589188822156056927590467915532990682212392730190959082411349977753577188501685162880216459",
                  t: {
                    "0": "6008075905725919393109498075228752704201474968393724984281651932253659767190052065447998311961340721854151833261947291121589506883563013776138177412043120907589992074264181920318787613074087694618880119020352958735598322839735897128055800209280019220239396036142789042748014846462243232009579648816328983474743207241061709696926938171834069546788146564973354423594171938713889978228256049806331041812714767228450607768177297850956191924123068984486888633702798008338751953051205216090025146455497896899925940051849451311521485002472741613575338665706330626779506196107875795814109671229572061836907282434409015592826",
                    "1": "4309415921252992399071814803637471181034654454405709326676076066374469816691990632177315062992121198314510971710560891065405294077560126086688284846964540294774164133910976391345721011169105324720583494130422278851715198678981198638574293813323499862214915265914201243069364006368241963108300877181796282067228432783412228061289057129488962243474194507516346557029914295576496399732316490107190432222509575032625974093218385715574345236730891626654186618540358152717674333720587231541780225184205225458603870270231091428648008462811626343958112136252365676230076957933041141840226246776458141943341859049844301702188",
                    "2": "3059868582896507267903954774697168608545014841918131596153765451517489118876512368375733362584762282416784225803448214654626944002380048296823794802960809017952665567792031433340343540914733179989954171859786491703662954943672836629018426409933839298242322909975125397926649926427907936699642799944297719824245004588864851183710691119913104297595283306388040530311173767413959165161572736079217433772928553897093374947474871077507582100511556418531214577977840068630327990917347129256831527366612430478200774656771026964585447320815852568152497232468543944411136151783806303804576195915210229811140899769097302412773",
                    "3": "4909780361996762726337412735076374851611617588051911973618585541136272814279563894491523673352459587287500273820648944218142737073981849244682720941011684452196676447928671422927390150496692981180535502734732686047675761182563176455177747832930357839012879263966750927903792299563824809937018584869146434871186060658572378662325624041382362497722733387567540989068199269214583977080150201530359325029457274542235546225644626794042540026926297780865635029474338129967746768036882275239799587542932367902031168330346571910764543306011522127059340787822647565791127468080061831307790639175389959038994266885180066587281",
                    DELTA: "3354544820647651355720276454256945704617727670994673350178064844426037181947030275823257994771689439205040827047853782916554212515767938479152843660630687721765095386427810674166622020483312647473414994585947235941320770960003669860391845728963387261575002246467865873881423713827007389216919874506009130725046237248887473932636572102619016282971112936014026964734438322235747534518783219301594792357544486848636724020316584216575394069441567201434606594606406217029122111708728464278486255647491897215452955687131298174319626297549197767947015118114915088583872727830206281369508371129622414478920487143823483067231",
                  },
                  predicate: {
                    attr_name: "age",
                    p_type: "GE",
                    value: 18,
                  },
                },
              ],
            },
          },
        ],
        aggregated_proof: {
          c_hash: "49174421319938256583762782015663733712480918038699531953067390414890888248633",
          c_list: [
            [
              13,
              89,
              188,
              183,
              77,
              1,
              198,
              6,
              176,
              8,
              7,
              11,
              148,
              65,
              227,
              96,
              48,
              159,
              104,
              253,
              87,
              195,
              70,
              108,
              31,
              242,
              232,
              27,
              203,
              175,
              196,
              122,
              26,
              57,
              121,
              123,
              114,
              180,
              181,
              139,
              146,
              107,
              236,
              164,
              139,
              190,
              119,
              29,
              254,
              173,
              219,
              219,
              131,
              65,
              253,
              125,
              174,
              81,
              46,
              12,
              197,
              9,
              182,
              106,
              236,
              56,
              204,
              174,
              84,
              98,
              46,
              210,
              64,
              138,
              102,
              217,
              217,
              166,
              62,
              95,
              65,
              55,
              117,
              200,
              196,
              131,
              231,
              162,
              171,
              123,
              33,
              137,
              236,
              179,
              9,
              124,
              59,
              45,
              149,
              12,
              146,
              91,
              87,
              222,
              227,
              242,
              45,
              104,
              225,
              181,
              134,
              81,
              207,
              86,
              8,
              116,
              9,
              239,
              62,
              68,
              242,
              127,
              54,
              213,
              27,
              114,
              40,
              2,
              199,
              160,
              61,
              164,
              64,
              41,
              182,
              8,
              36,
              177,
              245,
              180,
              195,
              246,
              36,
              151,
              254,
              117,
              36,
              238,
              239,
              64,
              186,
              159,
              136,
              171,
              58,
              91,
              64,
              27,
              196,
              236,
              198,
              202,
              198,
              48,
              232,
              43,
              82,
              64,
              221,
              28,
              0,
              173,
              54,
              82,
              90,
              211,
              156,
              115,
              97,
              63,
              39,
              24,
              28,
              34,
              195,
              75,
              243,
              72,
              134,
              111,
              62,
              3,
              150,
              232,
              57,
              167,
              7,
              84,
              18,
              135,
              70,
              25,
              21,
              137,
              243,
              135,
              20,
              218,
              142,
              87,
              36,
              108,
              164,
              56,
              92,
              42,
              134,
              252,
              196,
              18,
              203,
              58,
              207,
              121,
              54,
              194,
              39,
              86,
              109,
              105,
              119,
              30,
              144,
              236,
              146,
              56,
              109,
              121,
              154,
              187,
              87,
              109,
              22,
              132,
              125,
              49,
              53,
              231,
              133,
              163,
              170,
              237,
              95,
              152,
              102,
              182,
            ],
            [
              47,
              151,
              215,
              73,
              185,
              173,
              193,
              242,
              196,
              92,
              229,
              237,
              219,
              124,
              15,
              141,
              150,
              0,
              210,
              196,
              83,
              212,
              152,
              95,
              186,
              144,
              209,
              82,
              73,
              246,
              211,
              69,
              1,
              158,
              112,
              5,
              215,
              84,
              79,
              202,
              69,
              156,
              109,
              251,
              131,
              157,
              144,
              119,
              83,
              197,
              218,
              213,
              69,
              245,
              96,
              35,
              175,
              39,
              108,
              228,
              112,
              19,
              115,
              119,
              186,
              39,
              132,
              120,
              95,
              121,
              6,
              148,
              241,
              230,
              157,
              4,
              217,
              199,
              37,
              119,
              134,
              88,
              192,
              242,
              42,
              160,
              221,
              51,
              78,
              7,
              229,
              124,
              46,
              143,
              128,
              28,
              154,
              198,
              190,
              39,
              5,
              114,
              252,
              107,
              11,
              115,
              220,
              141,
              59,
              172,
              52,
              245,
              241,
              117,
              170,
              15,
              157,
              97,
              224,
              25,
              165,
              215,
              1,
              220,
              106,
              97,
              209,
              160,
              102,
              120,
              246,
              213,
              78,
              66,
              183,
              133,
              174,
              98,
              71,
              182,
              217,
              203,
              203,
              107,
              135,
              248,
              84,
              96,
              152,
              219,
              254,
              229,
              244,
              160,
              0,
              212,
              135,
              90,
              30,
              108,
              87,
              218,
              91,
              84,
              206,
              114,
              156,
              84,
              145,
              96,
              51,
              135,
              76,
              57,
              154,
              38,
              53,
              79,
              86,
              100,
              4,
              71,
              50,
              254,
              98,
              109,
              240,
              42,
              129,
              125,
              10,
              236,
              234,
              38,
              1,
              69,
              139,
              126,
              152,
              0,
              230,
              158,
              127,
              237,
              207,
              188,
              167,
              192,
              65,
              184,
              31,
              118,
              31,
              132,
              149,
              209,
              89,
              228,
              51,
              27,
              55,
              121,
              90,
              66,
              138,
              24,
              138,
              151,
              161,
              115,
              123,
              102,
              241,
              40,
              242,
              87,
              234,
              228,
              223,
              84,
              24,
              185,
              78,
              79,
              177,
              153,
              112,
              141,
              59,
              240,
              176,
              141,
              76,
              132,
              199,
              122,
            ],
            [
              34,
              35,
              28,
              63,
              9,
              228,
              18,
              190,
              87,
              185,
              203,
              135,
              54,
              213,
              119,
              156,
              228,
              46,
              73,
              117,
              27,
              117,
              94,
              152,
              64,
              104,
              0,
              35,
              11,
              20,
              225,
              203,
              109,
              159,
              164,
              150,
              123,
              33,
              15,
              137,
              97,
              116,
              161,
              70,
              193,
              142,
              201,
              213,
              210,
              100,
              77,
              36,
              5,
              56,
              60,
              229,
              89,
              81,
              204,
              58,
              188,
              195,
              153,
              98,
              225,
              124,
              149,
              108,
              102,
              60,
              219,
              191,
              176,
              227,
              218,
              54,
              58,
              102,
              219,
              255,
              94,
              199,
              225,
              148,
              185,
              100,
              199,
              190,
              93,
              49,
              223,
              114,
              178,
              104,
              226,
              55,
              33,
              22,
              22,
              106,
              99,
              17,
              211,
              141,
              210,
              76,
              33,
              212,
              97,
              190,
              55,
              110,
              38,
              194,
              99,
              99,
              217,
              100,
              249,
              168,
              11,
              204,
              62,
              139,
              54,
              177,
              101,
              75,
              30,
              210,
              252,
              249,
              119,
              58,
              103,
              164,
              125,
              185,
              34,
              112,
              39,
              75,
              151,
              209,
              64,
              34,
              97,
              35,
              33,
              47,
              181,
              96,
              141,
              18,
              198,
              100,
              230,
              237,
              50,
              155,
              12,
              230,
              129,
              250,
              143,
              209,
              170,
              199,
              120,
              240,
              199,
              78,
              242,
              206,
              51,
              230,
              19,
              23,
              227,
              79,
              30,
              239,
              80,
              222,
              252,
              35,
              185,
              89,
              109,
              213,
              144,
              209,
              214,
              111,
              202,
              115,
              81,
              35,
              22,
              234,
              192,
              37,
              149,
              144,
              247,
              146,
              63,
              231,
              250,
              72,
              12,
              110,
              128,
              249,
              163,
              135,
              202,
              176,
              209,
              115,
              115,
              161,
              68,
              4,
              108,
              225,
              187,
              183,
              187,
              117,
              80,
              102,
              206,
              23,
              113,
              244,
              65,
              160,
              146,
              2,
              127,
              106,
              141,
              132,
              68,
              172,
              49,
              205,
              170,
              82,
              216,
              27,
              242,
              137,
              36,
              44,
            ],
            [
              24,
              61,
              35,
              215,
              215,
              126,
              169,
              199,
              44,
              44,
              174,
              29,
              54,
              205,
              10,
              4,
              227,
              36,
              31,
              81,
              29,
              241,
              122,
              79,
              195,
              51,
              229,
              47,
              206,
              27,
              143,
              128,
              192,
              244,
              73,
              145,
              173,
              39,
              136,
              136,
              82,
              194,
              73,
              89,
              102,
              155,
              119,
              32,
              188,
              19,
              230,
              123,
              142,
              6,
              108,
              133,
              170,
              194,
              73,
              49,
              89,
              196,
              21,
              74,
              204,
              153,
              11,
              23,
              186,
              244,
              58,
              83,
              69,
              51,
              7,
              167,
              89,
              97,
              26,
              61,
              84,
              243,
              187,
              71,
              201,
              77,
              36,
              104,
              212,
              136,
              106,
              221,
              179,
              204,
              4,
              24,
              45,
              132,
              125,
              178,
              130,
              12,
              55,
              76,
              107,
              56,
              161,
              245,
              237,
              198,
              100,
              29,
              176,
              21,
              209,
              17,
              117,
              16,
              179,
              198,
              133,
              68,
              9,
              240,
              42,
              30,
              86,
              248,
              154,
              195,
              193,
              241,
              13,
              254,
              205,
              214,
              10,
              131,
              137,
              182,
              160,
              188,
              14,
              20,
              204,
              210,
              149,
              6,
              46,
              212,
              142,
              81,
              185,
              114,
              132,
              136,
              141,
              125,
              48,
              194,
              151,
              95,
              195,
              82,
              154,
              91,
              163,
              139,
              216,
              56,
              71,
              224,
              29,
              5,
              228,
              161,
              118,
              198,
              51,
              156,
              99,
              116,
              231,
              5,
              133,
              43,
              58,
              255,
              207,
              252,
              45,
              125,
              50,
              252,
              197,
              198,
              66,
              236,
              26,
              212,
              136,
              29,
              184,
              19,
              3,
              181,
              78,
              75,
              203,
              28,
              96,
              223,
              151,
              7,
              235,
              67,
              138,
              220,
              236,
              205,
              33,
              113,
              61,
              251,
              248,
              16,
              136,
              124,
              108,
              104,
              110,
              162,
              128,
              41,
              40,
              249,
              136,
              132,
              88,
              201,
              222,
              35,
              48,
              92,
              111,
              238,
              31,
              186,
              55,
              128,
              108,
              185,
              245,
              37,
              141,
              229,
            ],
            [
              38,
              228,
              152,
              132,
              22,
              197,
              236,
              107,
              242,
              17,
              37,
              44,
              102,
              24,
              143,
              197,
              76,
              250,
              239,
              102,
              218,
              145,
              141,
              157,
              200,
              217,
              226,
              145,
              63,
              135,
              156,
              207,
              199,
              195,
              184,
              5,
              212,
              111,
              91,
              228,
              205,
              195,
              76,
              243,
              46,
              207,
              210,
              247,
              44,
              150,
              235,
              148,
              112,
              176,
              189,
              122,
              151,
              188,
              78,
              32,
              39,
              16,
              226,
              212,
              221,
              64,
              229,
              193,
              52,
              245,
              203,
              73,
              172,
              205,
              167,
              83,
              13,
              78,
              253,
              237,
              136,
              95,
              17,
              70,
              199,
              186,
              111,
              193,
              15,
              139,
              196,
              255,
              123,
              119,
              216,
              215,
              246,
              102,
              254,
              151,
              121,
              20,
              47,
              16,
              144,
              249,
              90,
              72,
              48,
              90,
              35,
              122,
              0,
              12,
              214,
              239,
              152,
              39,
              192,
              35,
              97,
              203,
              135,
              144,
              132,
              48,
              48,
              19,
              40,
              190,
              166,
              165,
              72,
              19,
              10,
              189,
              115,
              108,
              53,
              246,
              227,
              58,
              244,
              192,
              252,
              229,
              102,
              109,
              51,
              143,
              214,
              57,
              118,
              78,
              34,
              206,
              97,
              240,
              141,
              9,
              141,
              221,
              70,
              102,
              91,
              2,
              234,
              243,
              237,
              216,
              28,
              168,
              21,
              255,
              82,
              151,
              16,
              71,
              163,
              233,
              129,
              32,
              122,
              51,
              254,
              190,
              49,
              160,
              21,
              142,
              103,
              181,
              133,
              38,
              33,
              187,
              83,
              243,
              101,
              229,
              223,
              93,
              158,
              63,
              130,
              248,
              236,
              226,
              163,
              110,
              205,
              213,
              140,
              144,
              174,
              90,
              112,
              146,
              239,
              54,
              19,
              106,
              87,
              168,
              197,
              114,
              111,
              121,
              234,
              107,
              210,
              121,
              129,
              196,
              84,
              243,
              69,
              22,
              103,
              246,
              243,
              163,
              5,
              65,
              189,
              131,
              35,
              56,
              199,
              221,
              154,
              73,
              166,
              183,
              98,
              145,
            ],
            [
              26,
              146,
              183,
              146,
              240,
              201,
              137,
              76,
              226,
              94,
              104,
              73,
              124,
              17,
              14,
              130,
              107,
              117,
              185,
              14,
              204,
              98,
              168,
              13,
              87,
              203,
              71,
              255,
              23,
              30,
              36,
              151,
              124,
              113,
              203,
              233,
              212,
              63,
              69,
              202,
              122,
              232,
              22,
              128,
              122,
              16,
              127,
              102,
              12,
              206,
              143,
              141,
              74,
              29,
              253,
              44,
              162,
              52,
              225,
              20,
              131,
              94,
              253,
              223,
              69,
              32,
              255,
              1,
              132,
              189,
              177,
              139,
              18,
              159,
              215,
              129,
              112,
              215,
              151,
              34,
              47,
              182,
              154,
              149,
              193,
              197,
              89,
              111,
              239,
              177,
              89,
              107,
              155,
              14,
              183,
              22,
              70,
              109,
              223,
              111,
              158,
              190,
              140,
              3,
              23,
              48,
              26,
              108,
              214,
              22,
              9,
              55,
              178,
              168,
              3,
              98,
              177,
              216,
              228,
              107,
              114,
              225,
              119,
              7,
              232,
              137,
              250,
              110,
              93,
              73,
              36,
              0,
              50,
              77,
              11,
              232,
              161,
              84,
              252,
              5,
              147,
              172,
              83,
              92,
              224,
              154,
              224,
              235,
              199,
              35,
              108,
              223,
              151,
              190,
              39,
              219,
              28,
              132,
              40,
              124,
              234,
              206,
              134,
              190,
              88,
              237,
              16,
              162,
              162,
              35,
              196,
              77,
              164,
              142,
              18,
              63,
              161,
              207,
              64,
              243,
              126,
              247,
              213,
              16,
              41,
              247,
              68,
              185,
              66,
              141,
              199,
              172,
              68,
              127,
              18,
              38,
              104,
              82,
              5,
              90,
              115,
              92,
              117,
              7,
              154,
              229,
              195,
              122,
              179,
              243,
              242,
              249,
              152,
              173,
              133,
              158,
              140,
              228,
              81,
              14,
              38,
              12,
              129,
              131,
              14,
              235,
              239,
              36,
              131,
              226,
              201,
              180,
              116,
              85,
              36,
              90,
              200,
              67,
              65,
              195,
              108,
              203,
              190,
              244,
              255,
              117,
              3,
              232,
              240,
              206,
              224,
              223,
              133,
              91,
              219,
              95,
            ],
          ],
        },
      },
      requested_proof: {
        revealed_attrs: {
          attr1_referent: {
            sub_proof_index: 0,
            raw: "test",
            encoded: "72155939486846849509759369733266486982821795810448245423168957390607644363272",
          },
        },
        self_attested_attrs: {
        },
        unrevealed_attrs: {
        },
        predicates: {
          age: {
            sub_proof_index: 0,
          },
        },
      },
      identifiers: [
        {
          schema_id: "did:web:xyz/resource/schema",
          cred_def_id: "did:web:xyz/resource/definition",
        },
      ],
    };

    const presentationRequest = {
      nonce: "568425184678903953469540",
      name: "anoncreds_presentation_request",
      version: "0.1",
      requested_attributes: {
        attr1_referent: {
          name: "name",
          restrictions: {
            cred_def_id: "did:web:xyz/resource/definition"
          },
        },
      },
      requested_predicates: {
        age: {
          name: "age",
          p_type: ">=",
          p_value: 18,
        },
      },
    };

    test("Should Verify to true when an Anoncreds Presentation submission with all valid attributes and predicates are used", async () => {
      const result = await ctx.run(new PresentationVerify({ presentationRequest, presentation, thid }));

      expect(result.pid).toEqual("valid");
      expect(result.data).toEqual(true);
    });

    test("Should Verify to false when attributes fail - name not recognised", async () => {
      const testRequest = JSON.parse(JSON.stringify(presentationRequest));
      testRequest.requested_attributes.attr1_referent = { ...testRequest.requested_attributes.attr1_referent, name: "not-a-name" };

      const result = await ctx.run(new PresentationVerify({ presentationRequest: testRequest, presentation, thid }));

      expect(result.pid).toEqual("valid");
      expect(result.data).toEqual(false);
    });

    test("Should Verify to false when attributes fail - restriction not met", async () => {
      const testRequest = JSON.parse(JSON.stringify(presentationRequest));
      testRequest.requested_attributes.attr1_referent.restrictions = {
        ...testRequest.requested_attributes.attr1_referent.restrictions,
        cred_def_id: "not-a-valid-id"
      };

      const result = await ctx.run(new PresentationVerify({ presentationRequest: testRequest, presentation, thid }));

      expect(result.pid).toEqual("valid");
      expect(result.data).toEqual(false);
    });

    test("Should Verify to false when predicates fail", async () => {
      const testRequest = JSON.parse(JSON.stringify(presentationRequest));
      testRequest.requested_predicates.age = { ...testRequest.requested_predicates.age, p_value: 100 };

      const result = await ctx.run(new PresentationVerify({ presentationRequest: testRequest, presentation, thid }));

      expect(result.pid).toEqual("valid");
      expect(result.data).toEqual(false);
    });

    test("Should Verify to false when an Anoncreds Presentation submission with invalid nonce", async () => {
      const testRequest = JSON.parse(JSON.stringify(presentationRequest));
      testRequest.nonce = "832231068342146277491801";

      const result = await ctx.run(new PresentationVerify({ presentationRequest: testRequest, presentation, thid }));

      expect(result.pid).toEqual("valid");
      expect(result.data).toEqual(false);
    });

    test("Should throw when presentation invalid", async () => {
      const testPresentation = {} as any;
      const sut = ctx.run(new PresentationVerify({ presentationRequest, presentation: testPresentation, thid }));

      expect(sut).rejects.toThrow("Presentation is invalid");
    });

    test("no presentationRequest - throws", async () => {
      vi.spyOn(pluto, "getAllMessages").mockResolvedValue([]);
      const sut = ctx.run(new PresentationVerify({ presentation, thid }));

      expect(sut).rejects.toThrow("Cannot find any message with that threadID");
    });

    test("presentationRequest message in Pluto - runs as expected", async () => {
      const attach = new AttachmentDescriptor({
        json: {
          nonce: "568425184678903953469540",
          name: "anoncreds_presentation_request",
          version: "0.1",
          requested_attributes: {
            attr1_referent: {
              name: "name",
              restrictions: {
                cred_def_id: "did:web:xyz/resource/definition"
              },
            },
          },
          requested_predicates: {
            age: {
              name: "age",
              p_type: ">=",
              p_value: 18,
            },
          },
        },
      });
      const msg = new RequestPresentation({} as any, [attach], Fixtures.DIDs.peerDID1, Fixtures.DIDs.peerDID2, thid);
      vi.spyOn(pluto, "getAllMessages").mockResolvedValue([msg.makeMessage()]);

      const result = await ctx.run(new PresentationVerify({ presentation, thid }));

      expect(result.pid).toEqual("valid");
      expect(result.data).toEqual(true);
    });

    test("presentationRequest message in Pluto - no attachment - throws", async () => {
      const msg = new RequestPresentation({} as any, [], Fixtures.DIDs.peerDID1, Fixtures.DIDs.peerDID2, thid);
      vi.spyOn(pluto, "getAllMessages").mockResolvedValue([msg.makeMessage()]);

      const sut = ctx.run(new PresentationVerify({ presentation, thid }));

      expect(sut).rejects.toThrow("Invalid presentation message, attachment missing");
    });

    test("no message in Pluto - throws", async () => {
      vi.spyOn(pluto, "getAllMessages").mockResolvedValue([]);

      const sut = ctx.run(new PresentationVerify({ presentation, thid }));

      expect(sut).rejects.toThrow("Cannot find any message with that threadID");
    });
  });
});
